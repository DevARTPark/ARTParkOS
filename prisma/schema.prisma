generator client {
  provider = "prisma-client-js"
}

// --- DATASOURCE (Managed by prisma.config.ts) ---
datasource db {
  provider = "postgresql"
  // URL is configured in prisma.config.ts
}

// --- ENUMS ---

enum Role {
  founder
  admin
  reviewer
  mentor
  supplier
  lab_owner
}

enum UserStatus {
  invited
  active
  suspended
}

enum TokenType {
  account_activation
  password_reset
  cofounder_invite
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  COMPLETED
  REJECTED
}

// --- 1. CORE IDENTITY ---

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String?
  
  roles         Role[]    @default([founder])
  
  status        UserStatus @default(invited)
  last_login    DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  tokens        AuthToken[]
  
  // âœ… Link to the Unified Profile (One profile for any role)
  profile       UserProfile? 
  
  @@map("users")
}

model AuthToken {
  id         String    @id @default(uuid())
  
  // Optional: User might not exist yet if it's a fresh invite
  user_id    String?   
  user       User?     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  token      String    @unique
  type       TokenType
  expires_at DateTime
  is_used    Boolean   @default(false)
  
  // Stores context like { "startupId": "xyz", "email": "..." }
  metadata   Json?     

  created_at DateTime  @default(now())

  @@map("auth_tokens")
}

// --- 2. UNIFIED PROFILE (The "Person") ---

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])

  // --- Common Fields ---
  fullName    String?
  phone       String?
  designation String?
  organization String? // <--- ADD THIS LINE (For non-founders)
  avatarUrl   String?  @db.Text
  linkedin    String?
  location    String?
  bio         String?  @db.Text

  // --- Founder Extension ---
  startupId   String?  
  startup     Startup? @relation(fields: [startupId], references: [id])

  updatedAt   DateTime @updatedAt
  
  @@map("user_profiles")
}

// --- 3. STARTUP ENTITY (The "Business") ---

model Startup {
  id          String   @id @default(uuid())
  
  name        String
  description String?  @db.Text
  website     String?
  logoUrl     String?
  industry    String?
  location    String?
  
  // --- UPDATED FIELDS ---
  pitchDeckUrl String? // <--- Added
  // stage     String? // <--- Removed
  
  foundedYear Int?     @default(2024)
  teamSize    Int?     @default(1)

  isProfileComplete Boolean @default(false) 

  team        UserProfile[]
  projects    Project[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("startups")
}

// --- 4. ASSESSMENT ENGINE ---

// The Rulebook (Managed by REVIEWERS)
model AssessmentQuestion {
  id             String   @id @default(uuid())
  text           String
  category       String   
  legacyCategory String?  // Stores old category name if deleted
  airlLevel      Int
  
  // Toggles
  isCritical     Boolean  @default(true)      // "Compulsory" flag
  scope          String   @default("project") // "project" or "company"
  
  expectations   String[]
  commentPrompt  String?  
  
  answers        AssessmentAnswer[]
  
  // Audit: Which Reviewer changed this?
  updatedBy      String?  
  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("assessment_questions")
}

// The Innovation (Managed by FOUNDERS)

model Project {
  id          String   @id @default(uuid())
  startupId   String
  startup     Startup  @relation(fields: [startupId], references: [id])
  
  name        String
  description String?  @db.Text
  domain      String?  // <--- ADD THIS (e.g. "AgriTech", "Drone")
  
  currentAIRL Int      @default(0) 
  
  submissions AssessmentSubmission[]

  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("projects")
}

// The Application (Snapshot of an attempt)
model AssessmentSubmission {
  id          String   @id @default(uuid())
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  
  targetLevel Int
  status      AssessmentStatus @default(DRAFT)
  
  // The Reviewer handling this specific ticket
  reviewerId  String?  // Null = Open Pool
  
  answers     AssessmentAnswer[]
  
  submittedAt DateTime?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("assessment_submissions")
}

// The Data (Founders Input + Reviewer Grade)
model AssessmentAnswer {
  id           String   @id @default(uuid())
  submissionId String
  submission   AssessmentSubmission @relation(fields: [submissionId], references: [id])
  
  questionId   String
  question     AssessmentQuestion   @relation(fields: [questionId], references: [id])
  
  // Founder Response
  response     String?  // "met", "partial", "not_met"
  notes        String?
  evidenceUrl  String?
  
  // Reviewer Evaluation
  rating       String?  // "yes", "no", "partial"
  comments     String?
  
  updatedAt    DateTime @updatedAt

  @@map("assessment_answers")
}