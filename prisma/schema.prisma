generator client {
  provider = "prisma-client-js"
}

// --- DATASOURCE (Managed by prisma.config.ts) ---
datasource db {
  provider = "postgresql"
  // URL is configured in prisma.config.ts
}

// --- ENUMS ---

enum Role {
  founder
  admin
  reviewer
  mentor
  supplier
  lab_owner
  applicant
}

enum UserStatus {
  invited
  active
  suspended
}

enum TokenType {
  account_activation
  password_reset
  cofounder_invite
}

enum AssessmentStatus {
  DRAFT
  SUBMITTED
  IN_REVIEW
  COMPLETED
  REJECTED
}

// --- NEW ENUMS FOR ASSESSMENT ---
enum QuestionScope {
  project
  company
}

enum FounderResponse {
  met
  partial
  not_met
}

enum ReviewerRating {
  yes
  no
  partial
}

// --- 1. CORE IDENTITY ---

model User {
  id            String    @id @default(uuid())
  email         String    @unique
  password_hash String?
  
  roles         Role[]    @default([founder])
  
  status        UserStatus @default(invited)
  last_login    DateTime?
  created_at    DateTime  @default(now())
  updated_at    DateTime  @updatedAt

  tokens        AuthToken[]
  
  // âœ… Link to the Unified Profile (One profile for any role)
  profile       UserProfile? 

  onboardingApplication OnboardingApplication?
  innovationAssessments InnovationAssessment[]
  
  @@map("users")
}

model AuthToken {
  id         String    @id @default(uuid())
  
  // Optional: User might not exist yet if it's a fresh invite
  user_id    String?   
  user       User?     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  token      String    @unique
  type       TokenType
  expires_at DateTime
  is_used    Boolean   @default(false)
  
  // Stores context like { "startupId": "xyz", "email": "..." }
  metadata   Json?     

  created_at DateTime  @default(now())

  @@map("auth_tokens")
}

// --- 2. UNIFIED PROFILE (The "Person") ---

model UserProfile {
  id          String   @id @default(uuid())
  userId      String   @unique
  user        User     @relation(fields: [userId], references: [id])

  // --- Common Fields ---
  fullName    String?
  phone       String?
  designation String?
  organization String? // <--- ADD THIS LINE (For non-founders)
  avatarUrl   String?  @db.Text
  linkedin    String?
  location    String?
  bio         String?  @db.Text

  // --- Founder Extension ---
  startupId   String?  
  startup     Startup? @relation(fields: [startupId], references: [id])

  updatedAt   DateTime @updatedAt
  
  @@map("user_profiles")
}

// --- 3. STARTUP ENTITY (The "Business") ---

model Startup {
  id          String   @id @default(uuid())
  
  name        String
  description String?  @db.Text
  website     String?
  logoUrl     String?
  industry    String?
  location    String?
  
  // --- UPDATED FIELDS ---
  pitchDeckUrl String? // <--- Added
  // stage     String? // <--- Removed
  
  foundedYear Int?     @default(2024)
  teamSize    Int?     @default(1)

  isProfileComplete Boolean @default(false) 

  team        UserProfile[]
  projects    Project[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("startups")
}

// --- 4. ASSESSMENT ENGINE ---

// 1. Categories (NEW MODEL)
// Replaces: localStorage.getItem("airl_categories")
model AssessmentCategory {
  id        String   @id @default(uuid())
  name      String   @unique
  order     Int      @default(0) // To keep the order in the UI
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("assessment_categories")
}

// 2. The Rulebook (Managed by REVIEWERS)
model AssessmentQuestion {
  id             String   @id @default(uuid())
  text           String
  
  // We keep this as a String (instead of a relation) to support 
  // your "Legacy Category" logic without complex foreign key constraints.
  category       String   
  legacyCategory String?  
  
  airlLevel      Int
  
  // Toggles
  isCritical     Boolean       @default(true) 
  scope          QuestionScope @default(project) // Updated to Enum
  
  // In Postgres, this creates a native array column text[]
  expectations   String[]      
  commentPrompt  String?       @default("Founder's Comments")
  
  answers        AssessmentAnswer[]
  
  // Audit
  updatedBy      String?  
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@map("assessment_questions")
}

// The Innovation (Managed by FOUNDERS)

model Project {
  id          String   @id @default(uuid())
  startupId   String
  startup     Startup  @relation(fields: [startupId], references: [id])
  
  name        String
  description String?  @db.Text
  domain      String?  // <--- ADD THIS (e.g. "AgriTech", "Drone")
  
  currentAIRL Int      @default(0) 
  
  submissions AssessmentSubmission[]

  createdBy   String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("projects")
}

// The Application (Snapshot of an attempt)
model AssessmentSubmission {
  id          String   @id @default(uuid())
  
  projectId   String
  project     Project  @relation(fields: [projectId], references: [id])
  
  targetLevel Int
  status      AssessmentStatus @default(DRAFT)
  
  // The Reviewer handling this specific ticket
  reviewerId  String?  // Null = Open Pool
  
  answers     AssessmentAnswer[]
  
  submittedAt DateTime?
  reviewedAt  DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("assessment_submissions")
}

// 3. The Data (Founders Input + Reviewer Grade)
model AssessmentAnswer {
  id           String   @id @default(uuid())
  
  submissionId String
  submission   AssessmentSubmission @relation(fields: [submissionId], references: [id])
  
  questionId   String
  question     AssessmentQuestion   @relation(fields: [questionId], references: [id])
  
  // Founder Response (Updated to Enum)
  response     FounderResponse? 
  notes        String?          @db.Text
  evidenceUrl  String?
  evidenceFile String?          // Added to store filename if uploaded
  
  // Reviewer Evaluation (Updated to Enum)
  rating       ReviewerRating?  
  comments     String?          @db.Text
  
  updatedAt    DateTime         @updatedAt

  @@map("assessment_answers")
}

model OnboardingApplication {
  id        String   @id @default(uuid())
  
  userId    String   @unique
  user      User     @relation(fields: [userId], references: [id])
  
  // Stores the entire JSON state from the Onboarding App
  // (Founder profile, startup details, answers, uploads)
  data      Json     
  
  status    String   @default("DRAFT") // DRAFT, SUBMITTED, APPROVED, REJECTED
  
  submittedAt DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("onboarding_applications")
}

model InnovationAssessment {
  id              String   @id @default(uuid())
  
  userId          String
  user            User     @relation(fields: [userId], references: [id])
  
  // Scoring Details
  totalScore      Float
  dimensionScores Json     // Stores breakdown like { "strategy": 15, "culture": 12 }
  answers         Json     // Stores the raw question-answer pairs
  
  // Final Classification (Green/Yellow/Red)
  bucket          String   
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("innovation_assessments")
}